{{- if .Values.emailsender.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: emailsender
  namespace: {{ .Release.Namespace }}
  labels:
    app: emailsender
spec:
  replicas: {{ .Values.emailsender.replicas }}
  selector:
    matchLabels:
      app: emailsender
  strategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: emailsender
    spec:
      serviceAccountName: emailsender
      containers:
        - name: emailsender
          # reuse an automatically updated `fleetshardSync.image.tag`
          # TODO(ROX-24499): rename FSS image tag to more generic name because it is used by other services
          image: "{{ .Values.emailsender.image.repo }}:{{ .Values.fleetshardSync.image.tag }}"
          imagePullPolicy: IfNotPresent
          command:
            - /usr/local/bin/emailsender
          env:
            - name: CLUSTER_ID
              value: {{ .Values.emailsender.clusterId }}
            - name: CLUSTER_NAME
              value: {{ .Values.emailsender.clusterName }}
            - name: ENVIRONMENT
              value: {{ .Values.emailsender.environment }}
          ports:
            - name: monitoring
              containerPort: 9090
            - name: server
              containerPort: 8080
          resources:
            limits:
              memory: {{ .Values.emailsender.resources.limits.memory | quote }}
            requests:
              cpu: {{ .Values.emailsender.resources.requests.cpu | quote }}
              memory: {{ .Values.emailsender.resources.requests.memory | quote }}
{{- end }}
